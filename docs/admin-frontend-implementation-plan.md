# План реализации отдельной админ-панели (React + Vite, без TypeScript)

## 1. Цель
Сделать отдельный фронтенд админки на отдельном домене/порту, который использует текущее API сервиса, но имеет отдельную логику, маршруты и UI для управления платформой обмена каналами.

## 2. Текущее состояние (что уже есть в проекте)
- Backend уже поддерживает роли пользователей (`user`, `admin`, `suspended`).
- Есть admin API:
  - `GET /api/admin/overview`
  - `GET /api/admin/users`
  - `PATCH /api/admin/users/:id/role`
  - `PATCH /api/admin/users/:id/suspend`
- Есть support чат между пользователями и админами:
  - `GET /api/support/chat`
  - `POST /api/support/chat/messages`
- Есть существующая страница админ-центра внутри основного фронтенда (`client/src/pages/admin/AdminControlCenterPage.jsx`), можно переиспользовать части логики/API-клиента.

## 3. Целевая архитектура
### 3.1 Отдельный фронтенд админки
- Создать новый проект: `admin-frontend/` (Vite + React, JS).
- Отдельный запуск на отдельном порту (например `5174`).
- Для продакшена предполагается отдельный домен (например `admin.yourdomain.com`).

### 3.2 Разграничение с основным фронтендом
- Полностью отдельные маршруты, layout, состояние и компоненты.
- Общий только backend API и auth-токен.
- В основном фронтенде не держать бизнес-логику админки (оставить только редирект/ссылку при необходимости).

### 3.3 Безопасность доступа
- Вход в админку через текущую auth-механику (Firebase token -> backend auth middleware).
- После логина проверка роли:
  - `admin` -> доступ в админ-панель
  - `user/suspended` -> запрет доступа + редирект
- Все админ-запросы только к `/api/admin/*` и `/api/support/*`.

## 4. Функциональные модули админки
### 4.1 Dashboard (аналитика)
- KPI карточки:
  - пользователи (всего/новые/активные)
  - каналы (всего/верифицированные)
  - офферы (open/matched/completed)
  - матчи/обмены (pending/accepted/completed/rejected)
  - отзывы (рейтинг/кол-во)
  - сообщения/обращения в поддержку
- Графики динамики (день/неделя/месяц) для ключевых метрик.
- Топ списки:
  - топ каналов по подписчикам/активности
  - топ пользователей по обменам

### 4.2 Управление пользователями
- Таблица пользователей: поиск, фильтры, пагинация.
- Карточка пользователя:
  - профиль, каналы, офферы, обмены, отзывы, сообщения.
- Действия:
  - смена роли (`user` <-> `admin`)
  - `suspend/restore`
- Обязательное логирование админ-действий в `action_logs`.

### 4.3 Управление каналами
- Список каналов с фильтрами (ниша, язык, страна, статус).
- Просмотр аналитики канала и истории обменов.
- Флаги модерации: mark flagged/unflagged + reason.

### 4.4 Управление офферами и обменами
- Каталог офферов с фильтрами и статусами.
- Модерация/закрытие оффера.
- Просмотр цепочки обмена (offer -> match -> chat -> completion -> review).

### 4.5 Чат админа с пользователями
- Отдельная страница «Support Inbox» в админке.
- Потоки сообщений:
  - общий список диалогов/обращений
  - просмотр переписки
  - ответ пользователю
- Использовать текущий `/api/support/chat` и `/api/support/chat/messages`.
- Поддержка вложений (из текущей реализации).

### 4.6 Аудит и события
- Просмотр `action_logs` (кто, когда, что изменил).
- Фильтры по actor/action/date.

## 5. Что нужно добавить/расширить в API
### 5.1 Дополнительные admin endpoints (предлагаемые)
- `GET /api/admin/analytics/timeseries?period=...`
- `GET /api/admin/channels`
- `PATCH /api/admin/channels/:id/flag`
- `GET /api/admin/offers`
- `PATCH /api/admin/offers/:id/status`
- `GET /api/admin/matches`
- `GET /api/admin/logs`
- `GET /api/admin/support/conversations` (если потребуется отдельная структура inbox)

### 5.2 Транзакционность и аудит (обязательное требование)
Для операций изменения данных (роль, suspend, модерация офферов/каналов):
- выполнять в транзакции;
- при ошибке rollback;
- писать audit запись в `action_logs`.

## 6. Сиды и роли
### 6.1 Первый админ
Добавить сид, который обеспечивает наличие админа:
- email: `vladkatintam@gmail.com`
- role: `admin`

### 6.2 Принцип работы с сидом
- Если пользователь уже существует -> обновить роль до `admin`.
- Если нет -> создать запись с минимальным профилем.
- Все операции с транзакцией.

## 7. UI/UX и дизайн (современный)
- Отдельный дизайн-сет для админки (не копия пользовательского кабинета).
- Современная структура:
  - фиксированный sidebar
  - topbar с поиском/быстрыми действиями
  - карточки метрик, графики, таблицы
- Единая визуальная система:
  - CSS variables (цвета, отступы, типографика)
  - контрастность, readable шрифты
  - адаптивность desktop/tablet

## 8. Технический план по этапам
### Этап 1: Каркас отдельного приложения
- Создать `admin-frontend/` на Vite React (JS).
- Настроить env (`VITE_API_URL`), API client, auth state, route guards.
- Настроить запуск на отдельном порту.

### Этап 2: Базовые страницы
- Login guard + Admin layout.
- Dashboard (метрики из `admin/overview`).
- Users management (список + role/suspend actions).

### Этап 3: Support чат для админа
- Страница сообщений поддержки.
- Список диалогов/сообщений и отправка ответа.

### Этап 4: Расширенная аналитика и модерация
- Каналы/офферы/обмены/логи.
- Добавление недостающих admin API endpoint’ов.

### Этап 5: Сиды и hardening
- Сид админа `vladkatintam@gmail.com`.
- Проверка транзакций и audit logging для админ-операций.

### Этап 6: Тесты
- Unit + functional:
  - frontend: guard, нормализация данных, UI-контракты
  - backend: admin endpoints, role change, support chat, audit logs
- Запуск полного test suite после изменений.

## 9. Критерии приемки
- Админка запускается отдельным приложением на отдельном порту.
- Доступ только для роли `admin`.
- Смена роли пользователя работает и логируется.
- Support чат из сервиса доступен и управляется из админки.
- Есть аналитические экраны с ключевыми метриками.
- Добавлен сид первого админа `vladkatintam@gmail.com`.
- Все тесты проходят.

## 10. Риски и примечания
- Нужно аккуратно синхронизировать auth-модель между двумя фронтендами.
- Для production нужно CORS/CSRF и доменные настройки cookie/token.
- Возможно потребуется расширение API для полноценных аналитических графиков.

---

Если план подтверждаешь, следующий шаг: начинаю Этап 1 (создание `admin-frontend/`, базовый каркас, auth guard, layout, dashboard и users management).
